<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>舞蹈培训中心管理系统</title>
	<link rel="stylesheet" type="text/css" href="/static/lib/jquery-easyui-1.5.2/themes/default/easyui.css">
	<link rel="stylesheet" type="text/css" href="/static/lib/jquery-easyui-1.5.2/themes/icon.css">
    <link rel="stylesheet" type="text/css" href="/static/css/IconExtension.css">
	<script type="text/javascript" src="/static/lib/jquery-easyui-1.5.2/jquery.min.js"></script>
	<script type="text/javascript" src="/static/lib/jquery-easyui-1.5.2/jquery.easyui.min.js"></script>

</head>
<body class="easyui-layout">
	<div data-options="region:'north',border:false" style="height:60px;background:#B3DFDA;padding:10px">north region</div>

	<div data-options="region:'west',split:true,hideCollapsedContent:false,title:'功能栏'" style="width:200px;">
        <div class="easyui-accordion" data-options="fit:true,border:false">
            <div title="学员管理" data-options="iconCls:'icon-student'" style="padding:1px">
                <ul id="treeStudent" class="easyui-tree" data-options="url:'/static/html/tree_student.json',method:'get',animate:true,dnd:true"></ul>
            </div>
            <div title="员工与老师" data-options="iconCls:'icon-teacher', selected:true" style="padding:1px">
                <ul id="treeTeacher" class="easyui-tree" data-options="url:'/static/html/tree_teacher.json',method:'get',animate:true,dnd:true"></ul>
            </div>
            <div title="教学管理" data-options="iconCls:'icon-book'" data-options="iconCls:'icon-help'" style="padding:1px">
                <ul id="treeSchool" class="easyui-tree" data-options="url:'/static/html/tree_school.json',method:'get',animate:true,dnd:true"></ul>
            </div>
            <div title="物品管理" data-options="iconCls:'icon-computer'" style="padding:1px">
                <ul id="treeAsset" class="easyui-tree" data-options="url:'/static/html/tree_asset.json',method:'get',animate:true,dnd:true"></ul>
            </div>
            <div title="财务管理" data-options="iconCls:'icon-money_yen'" style="padding:1px">
                <ul id="treeFinance" class="easyui-tree" data-options="url:'/static/html/tree_finance.json',method:'get',animate:true,dnd:true"></ul>
            </div>
            <div title="数据管理" data-options="iconCls:'icon-databases'" style="padding:1px">
                <ul id="treeDb" class="easyui-tree" data-options="url:'/static/html/tree_db.json',method:'get',animate:true,dnd:true"></ul>
            </div>
        </div>
	</div>
	<div data-options="region:'south',border:false" style="height:50px;background:#A9FACD;padding:10px;">south region</div>

	<div data-options="region:'center'">
        <div class="easyui-tabs" data-options="fit:true,border:false,plain:true" id="danceTabs">
            <div title="About" data-options="href:'/static/html/_content.html'" style="padding:10px"></div>
            <div title="Test" data-options="" style="padding:2px">
                <table id="dg_machine_list"></table>
            </div>
            <div title="DataGrid" style="padding:2px">
                <table class="easyui-datagrid"
                       data-options="url:'/static/html/datagrid_data.json',method:'get',
                       singleSelect: true,
                       rownumbers: true,
                       pagination: true,
                       fit:true,
                       fitColumns:true">
                    <thead>
                    <tr>
                        <th data-options="field:'itemid'" width="80">Item ID</th>
                        <th data-options="field:'productid'" width="100">Product ID</th>
                        <th data-options="field:'listprice',align:'right'" width="80">List Price</th>
                        <th data-options="field:'unitcost',align:'right'" width="80">Unit Cost</th>
                        <th data-options="field:'attr1'" width="150">Attribute</th>
                        <th data-options="field:'status',align:'center'" width="50">Status</th>
                    </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>

    <div id="win"></div>
    <div id="winExport"></div>

    <script>
        'use strict';

        $('.easyui-tree').tree({
            onClick: function(node){
                console.log('this.id=' + this.id + ', node.id=' + node.id + ', node.text=' + node.text);
                if($(this).tree('isLeaf',node.target)){  // 判断是否是叶子节点
                } else { $(this).tree('expand',node.target);
                }

                var tableId = this.id + node.id;
                if(node.text == '学员列表') {
                    danceAddTab('danceTabs', node.text, tableId);
                    danceCreateStudentDatagrid(tableId, '/dance_get_student');
                } else if (node.text == '班级信息') {
                    danceAddTab('danceTabs', node.text, tableId);
                    danceCreateClassDatagrid(tableId, '/dance_get_class');
                }else {
                    addTab(node.text,'http://jeasyui.com/', tableId);
                }
            }
        });

        function addTab(title, url, tabId){
            console.log(tabId);
            if ($('#danceTabs').tabs('exists', title)){
                $('#danceTabs').tabs('select', title);
            } else {
                var content = '<table id=' + tabId + '></table>';
                $('#danceTabs').tabs('add',{
                    title:title,
                    content:content,
                    closable:true
                });

                var data = [];
                $.ajax({
                    method : 'POST',
                    url : '/dance_get_user',
                    async : true,
                    dataType : 'json',
                    success : function(dd) {
                        console.log(dd);
                        var pt = eval(dd); // 数组
                        $.each(pt, function (index, item) {
                            data[index] = {
                                'id' : item.id,
                                'name' : item.nickname
                            };
                        });
                        $('#'+tabId).datagrid('loadData',data);
                    },
                    error : function() {
                        console.log('error in ajax.');
                    }
                });

                $('#'+tabId).datagrid({
                    rownumbers:true,
                    fitColumns:true,
                    pagination:true,
                    pageSize:10,
                    fit:true,
                    data:data.slice(0,10),
                    columns:[
                        [
                            {field:'id', align:"center", title:"id",width:100},
                            {field:'name', align:"center", title:"昵称",width:100}
                        ]
                    ]
                });
                var pager = $('#'+tabId).datagrid("getPager");
                pager.pagination({
                    total:data.length,
                    onSelectPage:function (pageNo, pageSize) {
                        var start = (pageNo - 1) * pageSize;
                        var end = start + pageSize;
                        $('#'+tabId).datagrid("loadData", data.slice(start, end));
                        pager.pagination('refresh', {
                            total:data.length,
                            pageNumber:pageNo
                        });
                    }
                });

            }
        }

        function createDatagrid(datagridId) {
            var _pageSize = 30;
            var _pageNo = 1;
            var dg = $('#' + datagridId);

            $(dg).datagrid({
                // title: '和仲位置信息',
                iconCls: 'icon-a_detail',
                fit: true,
                fitColumns: true,
                pagination: true,   // True to show a pagination toolbar on datagrid bottom.
                // singleSelect: true, // True to allow selecting only one row.
                loadMsg: '正在加载数据...',
                border: false,
                striped: true,
                pageNumber: 1,
                pageSize: _pageSize,     //每页显示条数
                nowrap: true,   // True to display data in one line. Set to true can improve loading performance.
                pageList: [20, 30, 40, 50, 100],   //每页显示条数供选项
                rownumbers: true,   // True to show a row number column.
                toolbar: [{
                    text:"增加", iconCls:'icon-add',
                    handler:function(){
                        alert('add');
                    }}, {
                    text:"编辑/查看", iconCls:'icon-edit',
                    handler:function(){
                        alert('edit');
                    }}, {
                    text:"删除", iconCls:'icon-remove',
                    handler:function(){
                        alert('del');
                    }}, '-', {
                    text: '姓名：<select class="easyui-combobox" panelHeight="auto" style="width:100px"></select>'
                    }, {
                    text:"查询", iconCls: 'icon-search',
                    handler: function () {
                        alert('查询');
                    }}
                ],
                columns: [[
                    {field: 'ck', checkbox:true },   // checkbox
                    // {field: 'no', title: '序号',  width: 15, align: 'center' },  //能自动显示行号，则不再需要自己实现
                    {field: 'id', title: 'id',  width: 30, align: 'center' },
                    {field: 'build_id', title: '建筑ID', width: 70, align: 'center'},
                    {field: 'floor_no', title: '楼层', width: 100, align: 'center'},
                    {field: 'user_id', title: '用户ID', width: 70, align: 'center'},
                    {field: 'x', title: 'x坐标', width: 70, align: 'center'},
                    {field: 'y', title: 'y坐标', width: 70, align: 'center'},
                    {field: 'timestamp', title: '时间戳', width: 120, align: 'center'}
                ]],
                onLoadSuccess: function () {
                    $(dg).datagrid("fixRownumber");
                    $(dg).datagrid('loaded');
                }
            });

            var pager = dg.datagrid('getPager');
            $(pager).pagination({
                //pageSize: _pageSize,//每页显示的记录条数，默认为10
                //pageList: [20, 30, 40, 50],//可以设置每页记录条数的列表
                beforePageText: '第',//页数文本框前显示的汉字
                afterPageText: '页, 共 {pages} 页',
                displayMsg: '当前记录 {from} - {to} , 共 {total} 条记录',
                onSelectPage: function (pageNumber, pageSize) {
                    $(dg).datagrid('loading');  // 打开等待div
                    console.log('pageNo=' + pageNumber + " pageSize=" + pageSize);
                    // 改变opts.pageNumber和opts.pageSize的参数值，用于下次查询传给数据层查询指定页码的数据
                    var gridOpts = $(dg).datagrid('options');
                    gridOpts.pageNumber = pageNumber;
                    gridOpts.pageSize = pageSize;

                    _pageSize = pageSize;
                    _pageNo = pageNumber;
                    doAjax();
                }
            });

            // 先通过ajax获取数据，然后再传给datagrid
            var doAjax = function () {
                $.ajax({
                    method: 'POST',
                    url: '/dance_get_location',
                    async: true,
                    dataType: 'json',
                    data: {'pageSize': _pageSize, 'pageNo': _pageNo},
                    success: function (data) {
                        console.log(data);

                        // 注意此处从数据库传来的data数据有记录总行数的total列和 rows
                        dg.datagrid('loadData', data);
                    },
                    error: function () {
                        console.log('error in ajax.');
                    }
                });
            };

            doAjax();   // 获取数据
        }

        createDatagrid('dg_machine_list');

    </script>

</body>
<script src="/static/js/dancestudent.js?ver=2"></script>
<script src="/static/js/danceclass.js"></script>
</html>